<!DOCTYPE html>
<html class="light" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>DocuMind LM - Upload Documents</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined"
      rel="stylesheet"
    />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            colors: {
              primary: "#000000",
              secondary: "#ffffff",
              "background-light": "#ffffff",
              "background-dark": "#000000",
              "text-light": "#000000",
              "text-dark": "#ffffff",
              "border-light": "#000000",
              "border-dark": "#ffffff",
              "card-light": "#ffffff",
              "card-dark": "#000000",
              "gray-light": "#f5f5f5",
              "gray-dark": "#1a1a1a",
              accent: "#333333",
              "accent-dark": "#cccccc",
            },
            fontFamily: { display: ["Inter", "sans-serif"] },
          },
        },
      };
    </script>
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 400, "GRAD" 0, "opsz" 24;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.05);
        }
      }
      @keyframes dragPulse {
        0%,
        100% {
          border-color: currentColor;
          background-color: transparent;
        }
        50% {
          border-color: #000000;
          background-color: rgba(0, 0, 0, 0.05);
        }
      }
      .dark @keyframes dragPulse {
        50% {
          border-color: #ffffff;
          background-color: rgba(255, 255, 255, 0.05);
        }
      }
      .animate-fadeInUp {
        animation: fadeInUp 0.8s ease-out;
      }
      .animate-pulse-custom {
        animation: pulse 2s infinite;
      }
      .drag-zone {
        transition: all 0.3s ease;
      }
      .drag-zone.drag-over {
        animation: dragPulse 1s infinite;
        transform: scale(1.02);
        border-width: 3px;
      }
      .progress-bar {
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body
    class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark transition-colors duration-500"
  >
    <div class="relative flex h-auto min-h-screen w-full flex-col">
      <div class="layout-container flex h-full grow flex-col">
        <header
          class="flex items-center justify-between border-b border-border-light dark:border-border-dark px-6 py-4"
        >
          <div class="flex items-center gap-3">
            <div class="text-primary dark:text-secondary">
              <svg
                class="size-6"
                fill="none"
                viewbox="0 0 48 48"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z"
                  fill="currentColor"
                ></path>
              </svg>
            </div>
            <h2 class="text-xl font-bold">DocuMind LM</h2>
          </div>
          <div class="flex gap-4">
            <button
              class="flex items-center rounded-lg h-10 px-4 hover:bg-gray-light dark:hover:bg-gray-dark"
              onclick="window.location.href='/'"
            >
              <span class="material-symbols-outlined mr-2">home</span>
              <span class="text-sm font-medium">Back to Home</span>
            </button>
            <button
              class="flex items-center rounded-lg h-10 w-10 hover:bg-gray-light dark:hover:bg-gray-dark"
              onclick="toggleDarkMode()"
            >
              <span class="material-symbols-outlined">dark_mode</span>
            </button>
          </div>
        </header>
        <main class="flex flex-1 justify-center items-center py-10 px-4">
          <div class="w-full max-w-2xl animate-fadeInUp">
            <div class="text-center mb-8">
              <div
                class="size-20 mx-auto mb-4 text-primary dark:text-secondary animate-pulse-custom"
              >
                <svg
                  fill="none"
                  viewBox="0 0 48 48"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path
                    d="M24 4C25.7818 14.2173 33.7827 22.2182 44 24C33.7827 25.7818 25.7818 33.7827 24 44C22.2182 33.7827 14.2173 25.7818 4 24C14.2173 22.2182 22.2182 14.2173 24 4Z"
                    fill="currentColor"
                  ></path>
                </svg>
              </div>
              <h1 class="text-3xl font-bold mb-2">Upload Your Documents</h1>
              <p class="text-accent dark:text-accent-dark">
                Transform your documents with AI-powered analysis
              </p>
            </div>

            <div
              class="bg-card-light dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark p-8 shadow-lg"
              id="upload-card"
            >
              <div
                class="flex flex-col items-center gap-6 rounded-lg border-2 border-dashed border-border-light dark:border-border-dark px-6 py-14 text-center drag-zone"
                id="drop-zone"
              >
                <div
                  class="flex items-center justify-center size-16 rounded-full bg-primary/10 dark:bg-secondary/10 text-primary dark:text-secondary"
                >
                  <span
                    class="material-symbols-outlined"
                    style="font-size: 32px"
                    >upload_file</span
                  >
                </div>
                <div class="flex flex-col items-center gap-2">
                  <p class="text-lg font-bold">Upload Your Documents</p>
                  <p class="text-sm text-accent dark:text-accent-dark">
                    Drag & drop files here or click to browse
                  </p>
                </div>
                <button
                  class="flex items-center justify-center rounded-lg h-12 px-6 bg-primary dark:bg-secondary text-secondary dark:text-primary font-bold hover:bg-accent dark:hover:bg-accent-dark"
                  id="file-button"
                >
                  <span class="material-symbols-outlined mr-2"
                    >folder_open</span
                  >
                  <span>Choose Files</span>
                </button>
                <p class="text-xs text-accent dark:text-accent-dark">
                  Supports PDF files of any size.
                </p>
              </div>
              <input type="file" id="file-input" accept=".pdf" class="hidden" />
            </div>

            <div
              class="mt-8 bg-card-light dark:bg-card-dark rounded-xl border border-border-light dark:border-border-dark p-8 shadow-lg hidden"
              id="progress-card"
            >
              <div class="flex flex-col gap-4">
                <div class="flex items-center gap-4">
                  <div
                    class="flex items-center justify-center size-12 rounded-lg bg-primary/10 dark:bg-secondary/10 text-primary dark:text-secondary"
                    id="file-icon"
                  >
                    <span class="material-symbols-outlined">description</span>
                  </div>
                  <div class="flex-1">
                    <p class="text-sm font-medium" id="file-name">
                      Uploading...
                    </p>
                    <p
                      class="text-xs text-accent dark:text-accent-dark"
                      id="file-size"
                    >
                      0 MB
                    </p>
                  </div>
                  <button
                    class="text-accent dark:text-accent-dark hover:text-red-500"
                    id="cancel-button"
                  >
                    <span class="material-symbols-outlined">close</span>
                  </button>
                </div>
                <div class="flex flex-col gap-2">
                  <div class="flex justify-between">
                    <p class="text-sm font-medium" id="upload-status">
                      Uploading...
                    </p>
                    <p
                      class="text-sm font-medium text-primary dark:text-secondary"
                      id="upload-percentage"
                    >
                      0%
                    </p>
                  </div>
                  <div
                    class="w-full rounded-full bg-gray-light dark:bg-gray-dark h-3 overflow-hidden"
                  >
                    <div
                      class="h-full rounded-full bg-primary dark:bg-secondary progress-bar"
                      id="progress-bar"
                      style="width: 0%"
                    ></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      const API_BASE_URL = "http://localhost:8000";

      document.addEventListener("DOMContentLoaded", function () {
        const uploadCard = document.getElementById("upload-card");
        const progressCard = document.getElementById("progress-card");
        const dropZone = document.getElementById("drop-zone");
        const fileInput = document.getElementById("file-input");
        const fileButton = document.getElementById("file-button");
        const fileName = document.getElementById("file-name");
        const fileSize = document.getElementById("file-size");
        const uploadStatus = document.getElementById("upload-status");
        const uploadPercentage = document.getElementById("upload-percentage");
        const progressBar = document.getElementById("progress-bar");
        const cancelButton = document.getElementById("cancel-button");
        const fileIcon = document.getElementById("file-icon");

        let uploadAbortController = null;

        function toggleDarkMode() {
          document.documentElement.classList.toggle("dark");
          localStorage.setItem(
            "darkMode",
            document.documentElement.classList.contains("dark")
          );
        }
        window.toggleDarkMode = toggleDarkMode;

        if (localStorage.getItem("darkMode") === "true") {
          document.documentElement.classList.add("dark");
        }

        fileButton.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", handleFiles);

        dropZone.addEventListener("dragover", (e) => {
          e.preventDefault();
          dropZone.classList.add("drag-over");
        });

        dropZone.addEventListener("dragleave", (e) => {
          e.preventDefault();
          if (!dropZone.contains(e.relatedTarget)) {
            dropZone.classList.remove("drag-over");
          }
        });

        dropZone.addEventListener("drop", (e) => {
          e.preventDefault();
          dropZone.classList.remove("drag-over");
          const files = e.dataTransfer.files;
          if (files.length > 0) {
            handleFiles({ target: { files } });
          }
        });

        cancelButton.addEventListener("click", () => {
          if (uploadAbortController) {
            uploadAbortController.abort();
          }
          showUploadCard();
        });

        async function handleFiles(event) {
          const files = event.target.files;
          if (files.length === 0) return;

          const file = files[0];

          if (!file.name.endsWith(".pdf")) {
            alert("Please select a PDF file");
            return;
          }

          // No file size limit

          await uploadFile(file);
        }

        async function uploadFile(file) {
          fileName.textContent = file.name;
          fileSize.textContent = formatFileSize(file.size);

          uploadCard.classList.add("hidden");
          progressCard.classList.remove("hidden");

          uploadPercentage.textContent = "0%";
          progressBar.style.width = "0%";
          uploadStatus.textContent = "Uploading...";

          const token = localStorage.getItem("token");
          if (!token) {
            alert("Please login first");
            window.location.href = "/login";
            return;
          }

          const formData = new FormData();
          formData.append("file", file);

          uploadAbortController = new AbortController();

          try {
            const xhr = new XMLHttpRequest();

            xhr.upload.addEventListener("progress", (e) => {
              if (e.lengthComputable) {
                const percentComplete = (e.loaded / e.total) * 100;
                uploadPercentage.textContent =
                  Math.round(percentComplete) + "%";
                progressBar.style.width = percentComplete + "%";

                if (percentComplete > 25 && percentComplete < 30) {
                  uploadStatus.textContent = "Processing document...";
                } else if (percentComplete > 50 && percentComplete < 55) {
                  uploadStatus.textContent = "Analyzing content...";
                } else if (percentComplete > 75 && percentComplete < 80) {
                  uploadStatus.textContent = "Finalizing upload...";
                }
              }
            });

            xhr.addEventListener("load", async function () {
              if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                uploadPercentage.textContent = "100%";
                progressBar.style.width = "100%";
                uploadStatus.textContent = "Upload complete!";
                fileIcon.innerHTML =
                  '<span class="material-symbols-outlined" style="color: #10b981;">check_circle</span>';

                // Store file info
                localStorage.setItem("uploadedFile", JSON.stringify(response));

                setTimeout(() => {
                  window.location.href = "/";
                }, 1500);
              } else {
                throw new Error("Upload failed");
              }
            });

            xhr.addEventListener("error", function () {
              alert("Upload failed. Please try again.");
              showUploadCard();
            });

            xhr.open("POST", `${API_BASE_URL}/api/v1/upload-pdf`);
            xhr.setRequestHeader("Authorization", `Bearer ${token}`);
            xhr.send(formData);

            uploadAbortController.signal.addEventListener("abort", () => {
              xhr.abort();
            });
          } catch (error) {
            alert("Upload failed: " + error.message);
            showUploadCard();
          }
        }

        function showUploadCard() {
          progressCard.classList.add("hidden");
          uploadCard.classList.remove("hidden");
          fileInput.value = "";
          uploadAbortController = null;
        }

        function formatFileSize(bytes) {
          if (bytes === 0) return "0 Bytes";
          const k = 1024;
          const sizes = ["Bytes", "KB", "MB", "GB"];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return (
            parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i]
          );
        }
      });
    </script>
  </body>
</html>
